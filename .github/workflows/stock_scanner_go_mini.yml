name: ğŸ”„ æè‡´_æ¸©å’Œ

on:
  workflow_dispatch:
  push:
    paths:
      - 'stock_scanner_go_mini.py' 
      - '.github/workflows/stock_scanner_go_mini.yml'
  schedule:
    - cron: '23 7 * * *'  # åŒ—äº¬æ—¶é—´ 15:23 è¿è¡Œ

permissions:
  contents: write

jobs:
  run_scanner:
    timeout-minutes: 60 
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1 

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: âš™ï¸ å®‰è£…ä¾èµ–
        run: |
          pip install akshare pandas pytz numpy

      - name: ğŸš€ è¿è¡Œè‚¡ç¥¨ç­›é€‰è„šæœ¬
        run: |
          # ç¡®ä¿ç»“æœæ–‡ä»¶å¤¹å­˜åœ¨ï¼Œé˜²æ­¢è„šæœ¬æœªç”Ÿæˆæ–‡ä»¶å¤¹æ—¶æŠ¥é”™
          mkdir -p results
          python stock_scanner_go_mini.py

      - name: ğŸ’¾ è‡ªåŠ¨åŒæ­¥å¹¶æäº¤ç»“æœ
        run: |
          # 1. é…ç½® Git åŸºç¡€ä¿¡æ¯
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git config --global core.quotepath false
          
          # 2. æ£€æŸ¥ results ç›®å½•ä¸‹åŠå…¶å­ç›®å½•æ˜¯å¦æœ‰æ–°çš„ CSV æ–‡ä»¶ç”Ÿæˆ
          # ä½¿ç”¨ find å‘½ä»¤æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°çš„æ–‡ä»¶æ•°å¤§äº 0 åˆ™ç»§ç»­
          if [ -n "$(find results -name "*.csv" -type f 2>/dev/null)" ]; then
            echo "âœ… æ£€æŸ¥åˆ°æ–°ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶ï¼Œå‡†å¤‡å¤„ç† Git åŒæ­¥..."
            
            # 3. æš‚å­˜æ–°æ–‡ä»¶
            git add results/**/*.csv
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢« addï¼ˆé˜²æ­¢åªæœ‰ç©ºæ–‡ä»¶å¤¹çš„æƒ…å†µï¼‰
            if [ -n "$(git status --porcelain)" ]; then
              # 4. å…³é”®ï¼šå…ˆ Stash é¿å¼€ Rebase å†²çª
              git stash
              
              # 5. æ‹‰å–è¿œç¨‹æ›´æ–°å¹¶åˆå¹¶
              git pull origin ${{ github.ref_name }} --rebase
              
              # 6. é‡Šæ”¾æš‚å­˜çš„æ–‡ä»¶
              git stash pop || echo "No changes to pop"
              
              # 7. æœ€ç»ˆæäº¤å¹¶æ¨é€
              git add results/**/*.csv
              echo "å‘ç°æ•°æ®å˜åŠ¨ï¼Œå‡†å¤‡æäº¤..."
              git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æè‡´ç²¾é€‰ç»“æœ: $(date +'%Y-%m-%d %H:%M')"
              git push origin ${{ github.ref_name }}
            else
              echo "æ–‡ä»¶å†…å®¹ä¸ä»“åº“å·²æœ‰è®°å½•å®Œå…¨ä¸€è‡´ï¼Œè·³è¿‡æäº¤ã€‚"
            fi
          else
            echo "ğŸ¤” æœ¬æ¬¡æ‰«ææœªå‘ç°ç¬¦åˆæ¡ä»¶çš„æ ‡çš„ï¼ˆæ—  CSV ç”Ÿæˆï¼‰ï¼Œè·³è¿‡ Git æ“ä½œã€‚"
          fi
